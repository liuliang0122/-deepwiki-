# 聚合支付接入详细设计说明书

**文档密级**: 公司内部 A

## 修订记录

| 版本 | 修订日期   | 修订人     | 修订说明 |
| ---- | ---------- | ---------- | -------- |
| 1.0  | 2024-XX-XX | 系统架构师 | 初始版本 |

---

## 目录

- [1. 概述](#1-概述)
  - [1.1 文档描述](#11-文档描述)
  - [1.2 设计背景](#12-设计背景)
  - [1.3 术语、缩略语](#13-术语缩略语)
  - [1.4 兼容性要求](#14-兼容性要求)
  - [1.5 关联文档](#15-关联文档)
- [2. 需求分析](#2-需求分析)
  - [2.1 关键需求分析](#21-关键需求分析)
  - [2.2 需求影响范围评估](#22-需求影响范围评估)
- [3. 技术实现分析](#3-技术实现分析)
  - [3.1 重难点分析](#31-重难点分析)
  - [3.2 技术实现与决策](#32-技术实现与决策)
    - [3.2.0 payment-integration 系统架构图](#320-payment-integration-系统架构图)
    - [3.2.1 架构设计决策](#321-架构设计决策)
    - [3.2.2 技术方案](#322-技术方案)
  - [3.3 技术选型](#33-技术选型)
- [4. 系统详细设计](#4-系统详细设计)
  - [4.1 系统功能模块详细设计](#41-系统功能模块详细设计)
  - [4.2 数据模型设计和数据管理](#42-数据模型设计和数据管理)
- [5. 非功能性需求设计](#5-非功能性需求设计)
  - [5.1 前端安全性设计](#51-前端安全性设计)
  - [5.2 前端性能设计](#52-前端性能设计)
- [6. 边界处理和容错降级方案](#6-边界处理和容错降级方案)
- [7. 风险评估](#7-风险评估)
- [8. 参考文献](#8-参考文献)

---

## 1. 概述

### 1.1 文档描述

本文档旨在详细设计医疗 HIS 系统中多个业务场景接入聚合支付 payment-integration 框架的技术方案。通过统一接入聚合支付框架，实现支付业务的标准化、统一化管理，提升支付功能的可维护性和扩展性。

**预期目标**：

- 统一支付接口，简化支付业务集成
- 支持多种聚合支付平台（国卫、讯飞水滴等）
- 覆盖门诊挂号、门诊收费、住院预交金、住院结算等医疗场景
- 提供完善的错误处理和回滚机制
- 支持支付状态监听和事件驱动

### 1.2 设计背景

当前医疗 HIS 系统中存在多个支付场景，包括：

- 门诊收费和退费
- 住院预交金缴纳和退费
- 住院结算和退费

这些场景中部分已接入聚合支付，但接入方式不统一，存在代码重复、维护困难等问题。通过统一接入 payment-integration 框架，可以：

- 统一支付接口，减少代码重复
- 集中管理支付配置和开关
- 统一错误处理和日志记录
- 便于后续扩展新的支付平台

### 1.3 术语、缩略语

| 缩写    | 专用名词                                            |
| ------- | --------------------------------------------------- |
| HIS     | Hospital Information System，医院信息系统           |
| API     | Application Programming Interface，应用程序编程接口 |
| SDK     | Software Development Kit，软件开发工具包            |
| QR Code | Quick Response Code，二维码                         |
| BFF     | Backend For Frontend，前端后端                      |

### 1.4 兼容性要求

**浏览器兼容性**：

- Chrome 80+
- Firefox 75+
- Edge 80+
- Safari 13+

**系统环境**：

- Node.js 12.x 或 14.x
- Vue.js 2.6.4
- 支持 ES6+语法

**支付平台兼容性**：

- 国卫聚合支付
- 讯飞水滴聚合支付
- 支持通过配置扩展其他支付平台

### 1.5 关联文档

- [payment-integration README.md](../../packages/custom-third-src/payment-integration/README.md)
- [PaymentManager.js](../../packages/custom-third-src/payment-integration/managers/PaymentManager.js)
- [医疗 BU 前端详细设计文档规范](../../HAIC_WEB_BASE/.cursor/rules/全局/前端/00-医疗BU前端详细设计文档规范.mdc)
- [前端代码红线管控规范](../../HAIC_WEB_BASE/.cursor/rules/全局/前端/01-医疗BU前端代码红线管控规范.mdc)

---

## 2. 需求分析

### 2.1 关键需求分析

#### 2.1.1 功能需求详细分析

| 序号 | 需求                       | 描述                                                                 | 优先级 |
| ---- | -------------------------- | -------------------------------------------------------------------- | ------ |
| 1    | 门诊收费聚合支付           | 门诊收费流程中，当用户选择第三方支付方式时，调用聚合支付接口完成支付 | 高     |
| 2    | 门诊退费聚合支付退款       | 门诊退费流程中，当存在第三方支付金额时，调用聚合支付退款接口         | 高     |
| 3    | 住院预交金缴纳聚合支付     | 住院预交金缴纳流程中，当用户选择第三方支付方式时，调用聚合支付接口   | 高     |
| 4    | 住院预交金退费聚合支付退款 | 住院预交金退费流程中，当存在第三方支付订单号时，调用聚合支付退款接口 | 高     |
| 5    | 住院结算聚合支付           | 住院结算流程中，当用户选择第三方支付方式时，调用聚合支付接口         | 高     |
| 6    | 住院退费聚合支付退款       | 住院退费流程中，当存在第三方支付金额时，调用聚合支付退款接口         | 高     |
| 7    | 支付状态查询               | 支持查询支付订单状态，用于支付超时等异常场景                         | 中     |
| 8    | 支付配置管理               | 支持通过系统开关动态配置支付功能开关和支付平台类型                   | 中     |
| 9    | 错误处理和回滚             | 支付失败时，支持自动回滚已执行的业务操作                             | 高     |
| 10   | 支付日志记录               | 记录支付操作的详细日志，便于问题排查                                 | 中     |

#### 2.1.2 性能需求详细分析

| 需求项           | 指标要求           | 说明                 |
| ---------------- | ------------------ | -------------------- |
| 支付接口响应时间 | < 3 秒             | 支付接口调用响应时间 |
| 支付弹窗加载时间 | < 1 秒             | 支付弹窗组件加载时间 |
| 支付状态轮询间隔 | 2-5 秒             | 支付状态查询轮询间隔 |
| 并发支付支持     | 支持多用户同时支付 | 无状态设计，支持并发 |

#### 2.1.3 资源需求详细分析

| 资源类型   | 需求说明                                             |
| ---------- | ---------------------------------------------------- |
| 前端资源   | payment-integration 模块已集成，无需额外资源         |
| 后端接口   | 需要后端提供支付订单创建、支付状态查询、退款等接口   |
| 第三方服务 | 需要配置国卫或讯飞水滴等聚合支付平台的服务地址和密钥 |
| 存储资源   | 支付订单信息存储在 HIS 数据库中，无需额外存储        |

#### 2.1.4 系统运行环境及限制条件详细分析

| 限制条件     | 说明                                           |
| ------------ | ---------------------------------------------- |
| 网络环境     | 需要能够访问聚合支付平台的服务器               |
| 浏览器环境   | 需要支持现代浏览器，不支持 IE                  |
| 支付金额限制 | 支付金额必须大于 0，退款金额不能大于原支付金额 |
| 支付时效性   | 支付订单有时效性，超时后需要重新创建订单       |

### 2.2 需求影响范围评估

#### 2.2.1 对现有系统的影响

**影响的模块**：

1. **门诊收费模块** (`packages/outpatient-app/src/views/his-charge/opt-charge-station/charge-service-manager/charge.js`)

   - 在收费流程中增加聚合支付处理逻辑
   - 不影响现有现金支付流程

2. **门诊退费模块** (`packages/outpatient-app/src/views/his-charge/opt-charge-station/charge-service-manager/refund.js`)

   - 在退费流程中增加聚合支付退款处理逻辑
   - 不影响现有现金退费流程

3. **住院预交金模块** (`packages/haic-spa-hospital/src/views/hospital/deposit/`)

   - 押金缴纳：增加聚合支付处理逻辑
   - 押金退费：增加聚合支付退款处理逻辑

4. **住院结算模块** (`packages/haic-spa-hospital/src/views/hospital/in/charge-manage-services/charge/index.js`)

   - 在结算流程中增加聚合支付处理逻辑
   - 不影响现有医保结算流程

5. **住院退费模块** (`packages/haic-spa-hospital/src/views/hospital/in/charge-manage-services/refund/index.js`)
   - 在退费流程中增加聚合支付退款处理逻辑

#### 2.2.2 对关联系统的影响

- **后端 HIS 系统**：需要提供支付订单创建、状态查询、退款等接口支持
- **聚合支付平台**：需要配置支付平台的服务地址、密钥等信息
- **医保系统**：不影响医保结算流程，聚合支付在医保结算之后执行

---

## 3. 技术实现分析

### 3.1 重难点分析

#### 3.1.1 关键技术问题识别

1. **支付流程与业务流程的集成**

   - **难点**：支付流程需要嵌入到现有的收费/退费业务流程中，不能影响现有业务逻辑
   - **解决方案**：采用策略模式，在业务流程的关键节点插入支付处理逻辑，通过配置控制是否启用聚合支付

2. **支付状态同步**

   - **难点**：支付状态由第三方平台控制，需要实时同步到 HIS 系统
   - **解决方案**：采用轮询机制查询支付状态，同时支持支付平台主动回调通知

3. **错误处理和回滚**

   - **难点**：支付失败时需要回滚已执行的业务操作，避免数据不一致
   - **解决方案**：使用回滚工具`createChargeRevertHelper`，在支付失败时自动执行回滚操作

4. **多支付平台支持**

   - **难点**：不同支付平台的接口和参数可能不同
   - **解决方案**：使用 payment-integration 框架的统一接口，框架内部处理不同平台的差异

5. **支付弹窗管理**
   - **难点**：支付弹窗需要在不同业务场景中正确显示和关闭
   - **解决方案**：使用 DialogManager 统一管理弹窗生命周期，支持多实例

#### 3.1.2 可行性评估

| 技术点       | 可行性 | 风险评估                       |
| ------------ | ------ | ------------------------------ |
| 统一支付接口 | ✅ 高  | payment-integration 框架已实现 |
| 支付状态轮询 | ✅ 高  | 技术成熟，实现简单             |
| 错误回滚机制 | ✅ 高  | 已有回滚工具支持               |
| 多平台支持   | ✅ 中  | 需要适配不同平台接口           |
| 支付弹窗管理 | ✅ 高  | Vue 组件技术成熟               |

### 3.2 技术实现与决策

#### 3.2.0 payment-integration 系统架构图

**整体架构层次**：

payment-integration 框架采用分层架构设计，从上到下分为业务层、管理层、服务层、工具层和第三方平台层。

**架构图**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            业务层 (Business Layer)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  门诊收费    │  │  门诊退费    │  │  住院预交金  │  │  住院结算   │ │
│  │ ChargeService│  │ RefundService│  │ DepositService│  │ ChargeService│ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                 │                  │                  │         │
│         └─────────────────┴──────────────────┴──────────────────┘         │
│                                    │                                        │
└────────────────────────────────────┼──────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        管理层 (Management Layer)                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌──────────────────────────────┐                      │
│                    │    PaymentManager            │                      │
│                    │  (支付业务管理器 - 单例)     │                      │
│                    │                              │                      │
│                    │  • init()                    │                      │
│                    │  • processPayment()          │                      │
│                    │  • refund()                  │                      │
│                    │  • queryPaymentStatus()      │                      │
│                    │  • isAggregatedPaymentEnabled()│                   │
│                    └──────────┬───────────────────┘                      │
│                               │                                          │
│         ┌─────────────────────┼─────────────────────┐                  │
│         │                     │                     │                    │
│         ▼                     ▼                     ▼                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │DialogManager │    │ErrorManager  │    │PaymentConfig │              │
│  │(弹窗管理器)  │    │(错误管理器)  │    │(配置管理器)  │              │
│  └──────────────┘    └──────────────┘    └──────────────┘              │
│                                                                           │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        服务层 (Service Layer)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│                    ┌──────────────────────────────┐                      │
│                    │    PaymentFactory            │                      │
│                    │  (支付服务工厂 - 工厂模式)    │                      │
│                    │                              │                      │
│                    │  • create(paymentType)       │                      │
│                    └──────────┬───────────────────┘                      │
│                               │                                          │
│                               ▼                                          │
│                    ┌──────────────────────────────┐                      │
│                    │   BasePaymentService         │                      │
│                    │   (支付服务基类 - 抽象类)     │                      │
│                    │                              │                      │
│                    │  • createPayment()           │                      │
│                    │  • queryPaymentStatus()       │                      │
│                    │  • refund()                  │                      │
│                    │  • cancelPayment()           │                      │
│                    └──────────┬───────────────────┘                      │
│                               │                                          │
│         ┌─────────────────────┼─────────────────────┐                  │
│         │                     │                     │                    │
│         ▼                     ▼                     ▼                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │GuoWeiPayment │    │水滴Payment   │    │其他Payment   │              │
│  │Service       │    │Service       │    │Service       │              │
│  │(国卫支付)    │    │(预留)        │    │(预留)        │              │
│  └──────────────┘    └──────────────┘    └──────────────┘              │
│                                                                           │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      工具层 (Utility Layer)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │EventEmitter │  │   Logger     │  │PaymentError  │  │GlobalAccessor│ │
│  │(事件发射器) │  │(日志工具)    │  │(错误类)      │  │(全局访问器)  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    第三方平台层 (Third-party Layer)                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────┐              ┌──────────────┐                          │
│  │  国卫聚合支付│              │  讯飞水滴支付│                          │
│  │  (GuoWei)   │              │  (预留)     │                          │
│  └──────────────┘              └──────────────┘                          │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

**架构说明**：

1. **业务层**：各个业务模块（门诊收费、门诊退费、住院预交金、住院结算）通过统一的 PaymentManager 接口调用支付功能。

2. **管理层**：

   - **PaymentManager**：核心管理器，采用单例模式，提供统一的支付接口
   - **DialogManager**：管理支付弹窗的生命周期，支持多实例
   - **ErrorManager**：统一错误处理和重试机制
   - **PaymentConfig**：从系统开关获取支付配置

3. **服务层**：

   - **PaymentFactory**：工厂模式创建不同的支付服务实例
   - **BasePaymentService**：定义统一的支付服务接口
   - **具体支付服务**：实现不同聚合支付平台的具体逻辑（国卫、水滴等）

4. **工具层**：提供事件、日志、错误处理等基础工具类。

5. **第三方平台层**：对接外部聚合支付平台（国卫、水滴等）。

**数据流向**：

```
业务模块 → PaymentManager → PaymentFactory → PaymentService → 第三方平台
                ↓
         DialogManager (显示支付弹窗)
                ↓
         ErrorManager (错误处理和重试)
                ↓
         PaymentConfig (获取配置)
```

**关键设计模式**：

- **单例模式**：PaymentManager、DialogManager、ErrorManager、PaymentConfig
- **工厂模式**：PaymentFactory 创建不同的支付服务实例
- **策略模式**：不同支付平台通过不同的 PaymentService 实现
- **观察者模式**：通过 EventEmitter 实现事件驱动的支付状态通知

#### 3.2.1 架构设计决策

**决策 1：使用 payment-integration 框架**

- **理由**：框架已提供统一的支付接口，支持多平台，减少重复开发
- **影响**：需要按照框架规范接入，不能自定义支付流程

**决策 2：在业务流程中插入支付处理**

- **理由**：保持业务流程的完整性，支付作为业务流程的一个环节
- **影响**：需要在多个业务模块中增加支付处理代码

**决策 3：使用回滚工具处理支付失败**

- **理由**：保证数据一致性，避免支付失败导致的数据不一致
- **影响**：需要确保所有业务操作都支持回滚

#### 3.2.2 技术方案

**方案 1：统一支付处理函数**

- 在各个业务模块中创建统一的支付处理函数`_handleAggregatedPayment`
- 函数内部调用 PaymentManager 的统一接口
- 支持配置化的支付开关判断

**方案 2：支付状态管理**

- 使用 PaymentManager 的事件机制监听支付状态变化
- 支持支付超时自动取消
- 支持支付失败自动回滚

### 3.3 技术选型

| 序号 | 技术名称            | 版本  | 描述             | 选取理由                 |
| ---- | ------------------- | ----- | ---------------- | ------------------------ |
| 1    | payment-integration | 最新  | 聚合支付集成框架 | 统一支付接口，支持多平台 |
| 2    | Vue.js              | 2.6.4 | 前端框架         | 项目已使用，组件化开发   |
| 3    | EventEmitter        | -     | 事件发射器       | 支持支付状态监听         |
| 4    | axios               | -     | HTTP 客户端      | 支付接口调用             |

---

## 4. 系统详细设计

### 4.1 系统功能模块详细设计

#### 4.1.1 门诊收费聚合支付模块

##### 4.1.1.1 功能描述

在门诊收费流程中，当用户选择第三方支付方式（非现金）时，调用聚合支付接口完成支付。支付流程嵌入在 HIS 结算流程中，位于医保结算之后、HIS 结算之前。

**业务流程**：

```
医保预结算 => HIS预结算 => HIS创建订单 => 医保结算 => 【聚合支付】 => HIS结算 => 打印
```

**用例图**：

```
用户 -> 选择支付方式（非现金）
用户 -> 确认支付金额
系统 -> 判断是否开启聚合支付
系统 -> 调用聚合支付接口
系统 -> 显示支付二维码/支付链接
用户 -> 完成支付
系统 -> 查询支付状态
系统 -> 支付成功后继续HIS结算
```

##### 4.1.1.2 技术设计图

**时序图**：

```
用户 -> ChargeService: startCharge()
ChargeService -> PaymentManager: isAggregatedPaymentEnabled()
PaymentManager --> ChargeService: true/false
ChargeService -> PaymentManager: processPayment()
PaymentManager -> PaymentService: createPayment()
PaymentService -> 第三方平台: 创建支付订单
第三方平台 --> PaymentService: 返回支付信息
PaymentService --> PaymentManager: 支付结果
PaymentManager -> DialogManager: 显示支付弹窗
DialogManager --> 用户: 显示支付二维码
用户 -> 第三方平台: 完成支付
第三方平台 -> PaymentService: 支付回调
PaymentService -> PaymentManager: 支付成功事件
PaymentManager --> ChargeService: 支付完成
ChargeService -> HIS系统: 执行HIS结算
```

**流程图**：

```
开始
  ↓
判断是否开启聚合支付
  ↓ (否)
跳过支付，直接HIS结算
  ↓ (是)
获取支付方式信息
  ↓
构建支付参数
  ↓
调用PaymentManager.processPayment()
  ↓
显示支付弹窗
  ↓
轮询支付状态
  ↓
支付成功？ → (否) → 回滚操作 → 结束
  ↓ (是)
继续HIS结算
  ↓
结束
```

##### 4.1.1.3 界面分析

**页面结构**：

- 支付弹窗由 payment-integration 框架的`UniversalPaymentDialog`组件提供
- 弹窗显示支付二维码或支付链接
- 弹窗支持关闭和取消操作

**组件通信**：

- ChargeService 通过 PaymentManager 调用支付接口
- PaymentManager 通过 DialogManager 显示支付弹窗
- 支付状态通过事件机制通知 ChargeService

**UI 组件**：

- 使用 payment-integration 框架内置的支付弹窗组件
- 弹窗样式遵循项目 UI 规范

##### 4.1.1.4 输入接口设计

**PaymentManager.processPayment()参数**：

```javascript
{
  businessType: BUSINESS_TYPES.OUTPATIENT.CHARGE, // 业务类型：门诊收费
  chargeInfoId: orderResult?.chargeInfoId,        // 收费信息ID
  onlineType: chargeData.onlineType,              // 支付类型（支付宝/微信等）
  orderAmount: chargeData.thirdSelfPayAmount,     // 支付金额
}
```

**isAggregatedPaymentEnabled()参数**：

```javascript
{
  onlineType: chargeData.onlineType,              // 支付类型
  thirdSelfPayAmount: chargeData.thirdSelfPayAmount, // 支付金额
}
```

##### 4.1.1.5 输出接口设计

**processPayment()返回结果**：

```javascript
{
  finalStatus: PAYMENT_STATUS.SUCCESS,  // 支付最终状态
  revertHandler: Function,              // 回滚函数
  payOrderNo: String,                  // 支付订单号
  // ... 其他支付信息
}
```

**支付状态枚举**：

- `PAYMENT_STATUS.PENDING`: 待支付
- `PAYMENT_STATUS.PROCESSING`: 支付中
- `PAYMENT_STATUS.SUCCESS`: 支付成功
- `PAYMENT_STATUS.FAILED`: 支付失败
- `PAYMENT_STATUS.ABANDONED`: 放弃支付

##### 4.1.1.6 限制条件

1. **支付金额限制**：支付金额必须大于 0
2. **支付时效性**：支付订单有时效性，超时后需要重新创建
3. **支付方式限制**：仅支持配置的支付方式（支付宝、微信等）
4. **业务状态限制**：必须在 HIS 订单创建成功后才能调用支付接口

##### 4.1.1.7 其他说明

- 支付失败时会自动回滚已执行的业务操作
- 支付取消时会抛出`取消结算`异常，终止业务流程
- 支付超时会自动取消订单

#### 4.1.2 门诊退费聚合支付退款模块

##### 4.1.2.1 功能描述

在门诊退费流程中，当退费金额中包含第三方支付金额时，调用聚合支付退款接口完成退款。退款流程在 HIS 退费成功之后执行。

**业务流程**：

```
医保退费 => HIS预退费 => HIS创建订单 => 医保结算 => HIS退费 => 【聚合支付退款】 => 完成
```

##### 4.1.2.2 技术设计图

**时序图**：

```
RefundService -> HIS系统: 执行HIS退费
HIS系统 --> RefundService: 退费成功，返回退费信息
RefundService -> 判断: 是否存在第三方支付金额？
判断 --> (否) 结束
判断 --> (是)
RefundService -> PaymentManager: refund()
PaymentManager -> PaymentService: refund()
PaymentService -> 第三方平台: 调用退款接口
第三方平台 --> PaymentService: 退款结果
PaymentService --> PaymentManager: 退款成功
PaymentManager --> RefundService: 退款完成
```

##### 4.1.2.3 界面分析

- 退款操作在后台执行，无需用户界面
- 退款失败时显示错误提示

##### 4.1.2.4 输入接口设计

**PaymentManager.refund()参数**：

```javascript
{
  chargeInfoId: hisPrerefundResult?.chargeInfoId, // 收费信息ID
  refundAmount: refundInfoData?.thirdPayAmount,    // 退款金额
  payScanMode: refundInfoData?.scanMode,          // 支付扫码方式
}
```

##### 4.1.2.5 输出接口设计

**refund()返回结果**：

```javascript
{
  success: true,        // 退款是否成功
  refundOrderNo: String, // 退款订单号
  // ... 其他退款信息
}
```

##### 4.1.2.6 限制条件

1. **退款金额限制**：退款金额必须大于 0，且不能大于原支付金额
2. **退款时效性**：退款需要在支付订单有效期内进行
3. **业务状态限制**：必须在 HIS 退费成功后才能调用退款接口

##### 4.1.2.7 其他说明

- 退款失败时显示警告提示，但不影响 HIS 退费流程
- 退款操作是异步的，可能需要一定时间完成

#### 4.1.3 住院预交金缴纳聚合支付模块

##### 4.1.3.1 功能描述

在住院预交金缴纳流程中，当用户选择第三方支付方式时，调用聚合支付接口完成支付。支付流程在创建押金订单之后、确认收费之前执行。

**业务流程**：

```
创建押金订单 => 【聚合支付】 => 确认收费 => 完成
```

##### 4.1.3.2 技术设计图

**时序图**：

```
DepositChargeServices -> 创建押金订单
DepositChargeServices -> PaymentManager: isAggregatedPaymentEnabled()
PaymentManager --> DepositChargeServices: true/false
DepositChargeServices -> PaymentManager: processPayment()
PaymentManager -> PaymentService: createPayment()
PaymentService -> 第三方平台: 创建支付订单
第三方平台 --> PaymentService: 返回支付信息
PaymentService --> PaymentManager: 支付结果
PaymentManager -> DialogManager: 显示支付弹窗
用户 -> 第三方平台: 完成支付
第三方平台 -> PaymentService: 支付回调
PaymentService -> PaymentManager: 支付成功事件
PaymentManager --> DepositChargeServices: 支付完成
DepositChargeServices -> HIS系统: 确认收费
```

##### 4.1.3.3 界面分析

- 支付弹窗显示在住院应用容器中（`#haic-spa-hospital-container`）
- 支付弹窗样式遵循项目 UI 规范

##### 4.1.3.4 输入接口设计

**PaymentManager.processPayment()参数**：

```javascript
{
  businessType: '3',                    // 业务类型：住院预交金
  chargeInfoId: orderResult?.id,        // 押金订单ID
  onlineType: selectedPayMethod.onlineType, // 支付类型
  orderAmount: selectedPayMethod.thirdSelfPayAmount, // 支付金额
}
```

##### 4.1.3.5 输出接口设计

同 4.1.1.5

##### 4.1.3.6 限制条件

1. **支付金额限制**：押金金额必须大于 0
2. **业务状态限制**：必须在押金订单创建成功后才能调用支付接口

##### 4.1.3.7 其他说明

- 押金订单使用`id`字段作为`chargeInfoId`
- 支付失败时会回滚押金订单创建操作

#### 4.1.4 住院预交金退费聚合支付退款模块

##### 4.1.4.1 功能描述

在住院预交金退费流程中，当押金记录存在支付订单号（`payOrderNo`）时，调用聚合支付退款接口完成退款。退款流程在 HIS 退费确认之后执行。

**业务流程**：

```
预退费检查 => HIS退费确认 => 【聚合支付退款】 => 完成
```

##### 4.1.4.2 技术设计图

**时序图**：

```
DepositTable -> HIS系统: 确认退费
HIS系统 --> DepositTable: 退费成功，返回押金记录
DepositTable -> 判断: 是否存在payOrderNo？
判断 --> (否) 结束
判断 --> (是)
DepositTable -> PaymentManager: refund()
PaymentManager -> PaymentService: refund()
PaymentService -> 第三方平台: 调用退款接口
第三方平台 --> PaymentService: 退款结果
PaymentService --> PaymentManager: 退款成功
PaymentManager --> DepositTable: 退款完成
```

##### 4.1.4.3 界面分析

- 退款操作在后台执行，无需用户界面
- 退款失败时显示警告提示

##### 4.1.4.4 输入接口设计

**PaymentManager.refund()参数**：

```javascript
{
  payOrderNo: currentRecord?.payOrderNo,        // 支付订单号
  chargeInfoId: currentRecord.id,               // 押金记录ID
  refundAmount: currentRecord?.amount,          // 退款金额
  payScanMode: currentRecord?.scanMode,         // 支付扫码方式
  businessType: BUSINESS_TYPES.INPATIENT_PREPAY, // 业务类型
}
```

##### 4.1.4.5 输出接口设计

同 4.1.2.5

##### 4.1.4.6 限制条件

1. **退款条件限制**：必须存在`payOrderNo`才能调用退款接口
2. **退款金额限制**：退款金额不能大于原支付金额

##### 4.1.4.7 其他说明

- 退款失败时显示警告提示，但不影响 HIS 退费流程
- 使用`BUSINESS_TYPES.INPATIENT_PREPAY`作为业务类型标识

#### 4.1.5 住院结算聚合支付模块

##### 4.1.5.1 功能描述

在住院结算流程中，当用户选择第三方支付方式时，调用聚合支付接口完成支付。支付流程在医保结算之后、HIS 结算之前执行。

**业务流程**：

```
医保预结算 => HIS预结算 => HIS创建订单 => 医保结算 => 【聚合支付】 => HIS结算 => 完成
```

##### 4.1.5.2 技术设计图

**时序图**：

```
ChargeServices -> 医保结算
ChargeServices -> PaymentManager: isAggregatedPaymentEnabled()
PaymentManager --> ChargeServices: true/false
ChargeServices -> PaymentManager: processPayment()
PaymentManager -> PaymentService: createPayment()
PaymentService -> 第三方平台: 创建支付订单
第三方平台 --> PaymentService: 返回支付信息
PaymentService --> PaymentManager: 支付结果
PaymentManager -> DialogManager: 显示支付弹窗
用户 -> 第三方平台: 完成支付
第三方平台 -> PaymentService: 支付回调
PaymentService -> PaymentManager: 支付成功事件
PaymentManager --> ChargeServices: 支付完成
ChargeServices -> HIS系统: 执行HIS结算
```

##### 4.1.5.3 界面分析

- 支付弹窗显示在住院应用容器中（`#haic-spa-hospital-container`）
- 支付弹窗样式遵循项目 UI 规范

##### 4.1.5.4 输入接口设计

**PaymentManager.processPayment()参数**：

```javascript
{
  businessType: BUSINESS_TYPES.INPATIENT_CHARGE, // 业务类型：住院结算
  chargeInfoId: orderResult?.chargeInfoId,       // 收费信息ID
  onlineType: selectedPayMethod.onlineType,      // 支付类型
  orderAmount: selectedPayMethod.thirdSelfPayAmount, // 支付金额
}
```

##### 4.1.5.5 输出接口设计

同 4.1.1.5

##### 4.1.5.6 限制条件

1. **支付金额限制**：支付金额必须大于 0
2. **业务状态限制**：必须在 HIS 订单创建成功后才能调用支付接口

##### 4.1.5.7 其他说明

- 支付失败时会自动回滚已执行的业务操作
- 支付取消时会抛出`取消结算`异常，终止业务流程

#### 4.1.6 住院退费聚合支付退款模块

##### 4.1.6.1 功能描述

在住院退费（结算召回）流程中，当退费金额中包含第三方支付金额（`thirdPayAmount > 0`）时，调用聚合支付退款接口完成退款。退款流程在 HIS 退费成功之后执行。

**业务流程**：

```
医保退费 => HIS预退费 => HIS退费 => 【聚合支付退款】 => 完成
```

##### 4.1.6.2 技术设计图

**时序图**：

```
RefundServices -> HIS系统: 执行HIS退费
HIS系统 --> RefundServices: 退费成功，返回退费信息
RefundServices -> 判断: thirdPayAmount > 0？
判断 --> (否) 结束
判断 --> (是)
RefundServices -> PaymentManager: refund()
PaymentManager -> PaymentService: refund()
PaymentService -> 第三方平台: 调用退款接口
第三方平台 --> PaymentService: 退款结果
PaymentService --> PaymentManager: 退款成功
PaymentManager --> RefundServices: 退款完成
```

##### 4.1.6.3 界面分析

- 退款操作在后台执行，无需用户界面
- 退款失败时显示警告提示

##### 4.1.6.4 输入接口设计

**PaymentManager.refund()参数**：

```javascript
{
  chargeInfoId: currentChargeInfo.id,           // 收费信息ID
  refundAmount: currentChargeInfo?.thirdPayAmount, // 退款金额
  payScanMode: currentChargeInfo?.scanMode,      // 支付扫码方式
}
```

##### 4.1.6.5 输出接口设计

同 4.1.2.5

##### 4.1.6.6 限制条件

1. **退款条件限制**：必须`thirdPayAmount > 0`才能调用退款接口
2. **退款金额限制**：退款金额不能大于原支付金额

##### 4.1.6.7 其他说明

- 退款失败时显示警告提示，但不影响 HIS 退费流程
- 退款操作是异步的，可能需要一定时间完成

### 4.2 数据模型设计和数据管理

#### 4.2.1 数据模型设计

**支付订单数据模型**：

```javascript
{
  payOrderNo: String,        // 支付订单号（第三方平台返回）
  chargeInfoId: String,      // 收费信息ID（HIS系统）
  businessType: String,       // 业务类型
  orderAmount: Number,       // 订单金额
  onlineType: String,        // 支付类型（支付宝/微信等）
  payStatus: String,          // 支付状态
  scanMode: String,           // 扫码方式
  createTime: Date,          // 创建时间
  payTime: Date,             // 支付时间
}
```

**退款订单数据模型**：

```javascript
{
  refundOrderNo: String,      // 退款订单号（第三方平台返回）
  payOrderNo: String,         // 原支付订单号
  chargeInfoId: String,      // 收费信息ID
  refundAmount: Number,       // 退款金额
  refundStatus: String,       // 退款状态
  refundTime: Date,          // 退款时间
}
```

#### 4.2.2 数据和状态管理

**状态管理方案**：

- 支付状态由 PaymentManager 统一管理
- 支付状态通过事件机制通知业务模块
- 支付状态存储在 HIS 数据库中，通过`chargeInfoId`关联

**数据流向**：

```
业务模块 -> PaymentManager -> PaymentService -> 第三方平台
第三方平台 -> PaymentService -> PaymentManager -> 业务模块（事件通知）
```

**本地存储策略**：

- 不存储支付敏感信息
- 支付订单号存储在 HIS 数据库中
- 支付配置通过系统开关获取，不本地缓存

---

## 5. 非功能性需求设计

### 5.1 前端安全性设计

#### 5.1.1 XSS 攻击防护

- **支付金额验证**：前端验证支付金额格式，防止注入恶意脚本
- **支付参数转义**：所有支付参数在传递给后端前进行转义处理
- **支付弹窗隔离**：支付弹窗使用独立的 DOM 容器，避免样式污染

#### 5.1.2 CSRF 攻击防护

- **Token 校验**：支付接口调用时携带 CSRF Token
- **Referer 校验**：后端校验请求来源
- **SameSite Cookie**：支付相关 Cookie 设置 SameSite 属性

#### 5.1.3 点击劫持防护

- **X-Frame-Options**：支付弹窗页面设置 X-Frame-Options 头，防止被嵌入 iframe
- **支付弹窗检测**：检测支付弹窗是否被嵌套，如果被嵌套则拒绝显示

#### 5.1.4 本地存储数据安全

- **敏感信息加密**：支付订单号等敏感信息不存储在 localStorage 中
- **支付配置安全**：支付配置通过系统开关获取，不本地缓存

### 5.2 前端性能设计

#### 5.2.1 内存管理

- **事件监听清理**：组件销毁时移除支付事件监听器
- **弹窗实例管理**：支付弹窗使用后及时销毁，避免内存泄漏
- **定时器清理**：支付状态轮询定时器在支付完成或失败后及时清理

**内存泄漏防护代码示例**：

```javascript
// 在组件beforeDestroy中清理
beforeDestroy() {
  // 移除支付事件监听
  if (this.paymentManager) {
    this.paymentManager.off('paymentSuccess', this.handlePaymentSuccess)
    this.paymentManager.off('paymentError', this.handlePaymentError)
  }

  // 清理定时器
  if (this.paymentPollTimer) {
    clearInterval(this.paymentPollTimer)
  }
}
```

#### 5.2.2 加载性能优化

- **按需加载**：payment-integration 模块按需加载，不阻塞页面初始化
- **支付弹窗懒加载**：支付弹窗组件在需要时才加载
- **接口请求优化**：支付接口请求使用防抖，避免重复请求

#### 5.2.3 渲染性能优化

- **支付状态更新优化**：支付状态更新使用 Vue 的响应式机制，避免频繁 DOM 操作
- **支付弹窗渲染优化**：支付弹窗使用 v-if 控制显示，不显示时不渲染

---

## 6. 边界处理和容错降级方案

### 6.1 异常边界识别和处理方案

#### 6.1.1 支付接口异常

**异常场景**：

- 网络超时
- 接口返回错误
- 支付平台服务异常

**处理方案**：

```javascript
try {
  const result = await paymentManager.processPayment(params)
  // 处理支付成功
} catch (error) {
  // 网络超时：提示用户重试
  if (error.code === 'NETWORK_TIMEOUT') {
    this.$message.warning('支付超时，请重试')
    // 执行回滚操作
    revertHandler()
  }
  // 支付取消：终止业务流程
  else if (error.code === 'PAYMENT_CANCELLED') {
    throw new Error('取消结算')
  }
  // 其他错误：显示错误提示，执行回滚
  else {
    this.$message.error('支付失败：' + error.message)
    revertHandler()
  }
}
```

#### 6.1.2 支付状态查询异常

**异常场景**：

- 支付状态查询超时
- 支付状态查询失败
- 支付状态不一致

**处理方案**：

- 支付状态查询超时：增加重试次数，超过最大重试次数后提示用户手动查询
- 支付状态查询失败：记录错误日志，提示用户联系客服
- 支付状态不一致：记录异常日志，提示用户联系客服处理

#### 6.1.3 退款接口异常

**异常场景**：

- 退款接口调用失败
- 退款金额校验失败
- 退款订单不存在

**处理方案**：

```javascript
try {
  await paymentManager.refund(refundParams)
  // 退款成功
} catch (error) {
  // 退款失败：显示警告，但不影响HIS退费流程
  console.error('聚合支付退费失败:', error)
  this.$message.warning(error.message || '统一支付退费失败')
  // 继续执行后续流程，不抛出异常
}
```

### 6.2 服务异常容错机制

#### 6.2.1 支付平台服务不可用

**降级方案**：

- 检测到支付平台服务不可用时，自动跳过聚合支付，使用现金支付
- 记录服务不可用日志，通知运维人员

#### 6.2.2 支付配置获取失败

**降级方案**：

- 支付配置获取失败时，默认关闭聚合支付功能
- 记录配置获取失败日志，提示管理员检查系统开关配置

#### 6.2.3 支付弹窗加载失败

**降级方案**：

- 支付弹窗加载失败时，显示错误提示，允许用户取消支付
- 记录弹窗加载失败日志

---

## 7. 风险评估

### 7.1 技术风险

| 风险项             | 风险等级 | 风险描述                                   | 应对措施                                                                        |
| ------------------ | -------- | ------------------------------------------ | ------------------------------------------------------------------------------- |
| 支付接口不稳定     | 高       | 第三方支付平台接口可能不稳定，导致支付失败 | 1. 增加重试机制<br>2. 增加超时处理<br>3. 提供降级方案                           |
| 支付状态同步延迟   | 中       | 支付状态同步可能存在延迟，导致业务逻辑错误 | 1. 增加状态轮询机制<br>2. 支持支付平台主动回调<br>3. 增加状态一致性校验         |
| 支付金额精度问题   | 中       | 支付金额可能存在精度问题，导致支付失败     | 1. 使用 BigNumber.js 处理金额计算<br>2. 金额统一转换为分单位<br>3. 增加金额校验 |
| 支付弹窗兼容性问题 | 低       | 不同浏览器可能对支付弹窗支持不同           | 1. 测试主流浏览器兼容性<br>2. 提供降级方案                                      |

### 7.2 合规风险

| 风险项       | 风险等级 | 风险描述                           | 应对措施                                                                       |
| ------------ | -------- | ---------------------------------- | ------------------------------------------------------------------------------ |
| 支付数据安全 | 高       | 支付数据可能泄露，违反数据安全法规 | 1. 支付敏感信息加密传输<br>2. 不存储支付密码等敏感信息<br>3. 遵循 PCI DSS 标准 |
| 支付流程合规 | 中       | 支付流程可能不符合医疗行业规范     | 1. 遵循医疗行业支付规范<br>2. 保留支付操作日志<br>3. 支持支付对账              |

---

## 8. 参考文献

1. [payment-integration README.md](../../packages/custom-third-src/payment-integration/README.md)
2. [PaymentManager.js 源码](../../packages/custom-third-src/payment-integration/managers/PaymentManager.js)
3. [Vue.js 官方文档](https://cn.vuejs.org/)
4. [医疗 BU 前端详细设计文档规范](../../HAIC_WEB_BASE/.cursor/rules/全局/前端/00-医疗BU前端详细设计文档规范.mdc)
5. [前端代码红线管控规范](../../HAIC_WEB_BASE/.cursor/rules/全局/前端/01-医疗BU前端代码红线管控规范.mdc)
6. [前端内存泄漏防治规范](../../HAIC_WEB_BASE/.cursor/rules/全局/前端内存泄漏防治.mdc)

---

**文档结束**
